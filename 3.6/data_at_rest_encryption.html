

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#3f51b5">
  <script src="_static/javascripts/modernizr.js"></script>
  
  <script>
      window.ga = window.ga || function () {
          (ga.q = ga.q || []).push(arguments)
      };
      ga.l = +new Date;
      ga('create', 'UA-343802-3', 'auto');
      ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  
  
    <title>Data at Rest Encryption &#8212; Percona Server for MongoDB 3.6 Documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/material.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="_static/css/material.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <link rel="shortcut icon" href="_static/percona_favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="copyright" title="Copyright" href="copyright.html" />
    <link rel="next" title="Additional text search algorithm - ngram" href="ngram-full-text-search.html" />
    <link rel="prev" title="Enabling Authentication" href="enable-auth.html" />
<!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-WBVF48V');</script>
<!-- End Google Tag Manager -->

<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-WBVF48V"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  
   

  </head>
  <body dir=ltr
        data-md-color-primary=orange data-md-color-accent=grey>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#data_at_rest_encryption" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.percona.com/software/documentation" title="Percona Server for MongoDB 3.6 Documentation"
           class="md-header-nav__button md-logo">
          
              <img src="_static/percona-logo.svg" height="26"
                   alt="Percona Server for MongoDB 3.6 Documentation logo">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic"> <a href="https://www.percona.com/software/documentation">Percona Product Documentation</a></span>
          <span class="md-header-nav__topic"> Data at Rest Encryption </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="search.html" method="GET" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://github.com/percona/psmdb-docs" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    percona/psmdb-docs
  </div>
</a>
          </div>
        </div>
      
      
  
  <div class="md-flex__cell md-flex__cell--shrink dropdown">
    <button class="dropdownbutton">Versions</button>
    <div class="dropdown-content md-hero">
          <a title="3.6 (EOL)" href="https://docs.percona.com/percona-server-for-mongodb/3.6/">3.6 (EOL)</a>
      
          <a title="4.0 (EOL)" href="https://docs.percona.com/percona-server-for-mongodb/4.0/">4.0 (EOL)</a>
      
          <a title="4.2" href="https://docs.percona.com/percona-server-for-mongodb/4.2/">4.2</a>
      
          <a title="4.4" href="https://docs.percona.com/percona-server-for-mongodb/4.4/">4.4</a>
      
          <a title="5.0" href="https://docs.percona.com/percona-server-for-mongodb/5.0/">5.0</a>
      
          <a title="6.0" href="https://docs.percona.com/percona-server-for-mongodb/6.0/">6.0</a>
      
          <a title="Latest stable" href="https://docs.percona.com/percona-server-for-mongodb/latest/">Latest stable</a>
      
    </div>
  </div>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Percona Server for MongoDB 3.6 Documentation</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="index.html" title="Percona Server for MongoDB 3.6 Documentation" class="md-nav__button md-logo">
      
        <img src="_static/percona-logo.svg" alt=" logo" width="48" height="48">
      
    </a>
    <a href="index.html"
       title="Percona Server for MongoDB 3.6 Documentation">Percona Server for MongoDB 3.6 Documentation</a>
  </label>
    <div class="md-nav__source">
      <a href="https://github.com/percona/psmdb-docs" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    percona/psmdb-docs
  </div>
</a>
    </div>
  
  

  
  <ul class="md-nav__list">
    <li class="md-nav__item">
    
    
      <a href="comparison.html" class="md-nav__link">Feature Comparison</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="install/index.html" class="md-nav__link">Installing Percona Server for MongoDB</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="install/upgrade_from_mongodb.html" class="md-nav__link">Upgrading from MongoDB Community Edition</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="install/upgrade_from_34.html" class="md-nav__link">Upgrading from Version 3.4</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="inmemory.html" class="md-nav__link">Percona Memory Engine</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="mongorocks.html" class="md-nav__link">MongoRocks</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="hot-backup.html" class="md-nav__link">Hot Backup</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="rate-limit.html" class="md-nav__link">Profiling Rate Limit</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="authentication.html" class="md-nav__link">External Authentication</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="audit-logging.html" class="md-nav__link">Auditing</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="log-redaction.html" class="md-nav__link">Log Redaction</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="enable-auth.html" class="md-nav__link">Enabling Authentication</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    <label class="md-nav__link md-nav__link--active" for="__toc"> Data at Rest Encryption </label>
    
      <a href="#" class="md-nav__link md-nav__link--active">Data at Rest Encryption</a>
      
        
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#data-at-rest-encryption--page-root" class="md-nav__link">Data at Rest Encryption</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#vault-integration" class="md-nav__link">HashiCorp Vault Integration</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#key-rotation" class="md-nav__link">Key Rotation</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#local-key-management-using-a-keyfile" class="md-nav__link">Local key management using a keyfile</a>
        </li>
        <li class="md-nav__item"><a href="#encrypting-rollback-files" class="md-nav__link">Encrypting Rollback Files</a>
        </li>
        <li class="md-nav__item"><a href="#migrating-from-key-file-encryption-to-vault-encryption" class="md-nav__link">Migrating from Key File Encryption to HashiCorp Vault Encryption</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="_sources/data_at_rest_encryption.rst.txt">Show Source</a> </li>

    
    <li class="md-nav__item"><a class="md-nav__extra_link" href="https://github.com/percona/psmdb-docs/edit/3.6/source/data_at_rest_encryption.rst" target="_blank">
    <i class="fa fa-github"></i>    Edit this page</a> </li>
   
  </ul>
</nav>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="ngram-full-text-search.html" class="md-nav__link">Additional text search algorithm - <em>ngram</em></a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="switch_storage_engines.html" class="md-nav__link">Switching Storage Engines</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="switch_storage_engines.html#data-at-rest-encryption" class="md-nav__link">Data at Rest Encryption</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="setParameter.html" class="md-nav__link">Parameter Tuning</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="contact.html" class="md-nav__link">Contacting, Contributing, Reporting Bugs</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="release_notes/index.html" class="md-nav__link">Release Notes</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="glossary.html" class="md-nav__link">Glossary</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="copyright.html" class="md-nav__link">Copyright and Licensing Information</a>
      
    
    </li>
    <li class="md-nav__item">
    
    
      <a href="trademark-policy.html" class="md-nav__link">Trademark Policy</a>
      
    
    </li>
  </ul>
  

  <label class="md-nav__title md-nav__title--site" for="__drawer">
<a title="Download PDF Manual" onclick="_gaq.push(['b._trackEvent', 'Percona Server for MongoDB', 'Download', 'Download Manual Percona Server for MongoDB 3.6 ']);" href="https://learn.percona.com/download-percona-server-mongodb-3-6-manual" class="md-nav__link">Download PDF Manual <span class="glyphicon glyphicon-chevron-down"></span></a>
  </label>
</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#data-at-rest-encryption--page-root" class="md-nav__link">Data at Rest Encryption</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#vault-integration" class="md-nav__link">HashiCorp Vault Integration</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#key-rotation" class="md-nav__link">Key Rotation</a>
        </li></ul>
            </nav>
        </li>
        <li class="md-nav__item"><a href="#local-key-management-using-a-keyfile" class="md-nav__link">Local key management using a keyfile</a>
        </li>
        <li class="md-nav__item"><a href="#encrypting-rollback-files" class="md-nav__link">Encrypting Rollback Files</a>
        </li>
        <li class="md-nav__item"><a href="#migrating-from-key-file-encryption-to-vault-encryption" class="md-nav__link">Migrating from Key File Encryption to HashiCorp Vault Encryption</a>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="_sources/data_at_rest_encryption.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

    
    <li class="md-nav__item"><a class="md-nav__extra_link" href="https://github.com/percona/psmdb-docs/edit/3.6/source/data_at_rest_encryption.rst" target="_blank">
    <i class="fa fa-github"></i>    Edit this page</a> </li>
   
  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <div class="md-typeset" role="main">  
  <div class="alert alert-warning">  
    <p> This documentation is for the end of life version of Percona Server for MongoDB and is no longer supported. You may want to see the <a href="https://docs.percona.com/percona-server-for-mongodb/latest/">current</a> documentation.
    </p>
  </div>
 </div>

  
<span id="psmdb-data-at-rest-encryption"></span><h1 id="data-at-rest-encryption--page-root">Data at Rest Encryption<a class="headerlink" href="#data-at-rest-encryption--page-root" title="Permalink to this headline">¶</a></h1>
<p>Data at rest encryption for the WiredTiger storage engine in MongoDB was
introduced in MongoDB Enterprise version 3.2. to ensure that encrypted data
files can be decrypted and read by parties with the decryption key.</p>
<p class="rubric">Differences from Upstream</p>
<p>The data encryption at rest in <em>Percona Server for MongoDB</em> is introduced in version 3.6 to be compatible with
data encryption at rest in MongoDB. In the current release of <em>Percona Server for MongoDB</em>, the data encryption at rest does
not include support for <abbr title="Key Management Interoperability Protocol">KMIP</abbr>, or Amazon AWS key management
services. Instead, <em>Percona Server for MongoDB</em> is <a class="reference internal" href="#vault"><span class="std std-ref">integrated with HashiCorp Vault</span></a> for key management services.</p>
<p>Two types of keys are used for data at rest encryption:</p>
<ul class="simple">
<li><p>Database keys to encrypt data. They are stored internally, near the data that they encrypt.</p></li>
<li><p>The master key to encrypt database keys. It is kept separately from the data and database keys and requires external management.</p></li>
</ul>
<p>To manage the master key, use one of the supported key management options:</p>
<ul class="simple">
<li><p>Integration with an external key server (recommended). <em>Percona Server for MongoDB</em> is integrated with HashiCorp Vault for this purpose.</p></li>
<li><p>Local key management using a keyfile.</p></li>
</ul>
<p>Note that you can use only one of the key management options at a time. However, you can switch from one management option to another (e.g. from a keyfile to HashiCorp Vault). Refer to <a class="reference internal" href="#psmdb-encryption-mode-switch"><span class="std std-ref">Migrating from Key File Encryption to HashiCorp Vault Encryption</span></a> section for details.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>You can only enable data at rest encryption and provide all encryption settings on an empty database, when you start the <code class="docutils literal notranslate"><span class="pre">mongod</span></code> instance for the first time. You cannot enable or disable encryption while the <em>Percona Server for MongoDB</em> server is already running and / or has some data. Nor can you change the effective encryption mode by simply restarting the server. Every time you restart the server, the encryption settings must be the same.</p>
</div>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#vault-integration" id="id1">HashiCorp Vault Integration</a></p>
<ul>
<li><p><a class="reference internal" href="#key-rotation" id="id2">Key Rotation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#local-key-management-using-a-keyfile" id="id3">Local key management using a keyfile</a></p></li>
<li><p><a class="reference internal" href="#encrypting-rollback-files" id="id4">Encrypting Rollback Files</a></p></li>
<li><p><a class="reference internal" href="#migrating-from-key-file-encryption-to-vault-encryption" id="id5">Migrating from Key File Encryption to HashiCorp Vault Encryption</a></p></li>
</ul>
</div>
<p class="rubric">Important Configuration Options</p>
<p><em>Percona Server for MongoDB</em> supports the <code class="docutils literal notranslate"><span class="pre">encryptionCipherMode</span></code> option where you choose one of the following cipher modes:</p>
<ul class="simple">
<li><p>AES256-CBC</p></li>
<li><p>AES256-GCM</p></li>
</ul>
<p>By default, the AES256-CBC cipher mode is applied. The following example
demonstrates how to apply the AES256-GCM cipher mode when starting the
<strong class="program">mongod</strong> service:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mongod<span class="w"> </span>...<span class="w"> </span>--encryptionCipherMode<span class="w"> </span>AES256-GCM
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt>MongoDB Documentation: encryptionCipherMode Option</dt><dd><p><a class="reference external" href="https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-encryptionciphermode">https://docs.mongodb.com/manual/reference/program/mongod/#cmdoption-mongod-encryptionciphermode</a></p>
</dd>
</dl>
</div>

<span id="vault"></span><h2 id="vault-integration"><a class="toc-backref" href="#id1">HashiCorp Vault Integration</a><a class="headerlink" href="#vault-integration" title="Permalink to this headline">¶</a></h2>
<p>Starting from version 3.6.13-3.3, <em>Percona Server for MongoDB</em> provides HashiCorp Vault integration. HashiCorp Vault supports different secrets engines. <em>Percona Server for MongoDB</em> only supports the HashiCorp Vault
back end with KV Secrets Engine - Version 2 (API)
with versioning enabled.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt>Percona Blog: Using Vault to Store the Master Key for Data at Rest Encryption on <em>Percona Server for MongoDB</em></dt><dd><p><a class="reference external" href="https://www.percona.com/blog/2020/04/21/using-vault-to-store-the-master-key-for-data-at-rest-encryption-on-percona-server-for-mongodb/">https://www.percona.com/blog/2020/04/21/using-vault-to-store-the-master-key-for-data-at-rest-encryption-on-percona-server-for-mongodb/</a></p>
</dd>
<dt>How to configure the KV Engine:</dt><dd><p><a class="reference external" href="https://www.vaultproject.io/api/secret/kv/kv-v2.html">https://www.vaultproject.io/api/secret/kv/kv-v2.html</a></p>
</dd>
</dl>
</div>
<div class="admonition-vault-parameters admonition">
<p class="admonition-title">HashiCorp Vault Parameters</p>
<table>
<colgroup>
<col style="width: 25%"/>
<col style="width: 25%"/>
<col style="width: 15%"/>
<col style="width: 35%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command line</p></th>
<th class="head"><p>Config file</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>vaultServerName</p></td>
<td><p>security.vault.serverName</p></td>
<td><p>string</p></td>
<td><p>The IP address of the Vault server</p></td>
</tr>
<tr class="row-odd"><td><p>vaultPort</p></td>
<td><p>security.vault.port</p></td>
<td><p>int</p></td>
<td><p>The port on the Vault server</p></td>
</tr>
<tr class="row-even"><td><p>vaultTokenFile</p></td>
<td><p>security.vault.tokenFile</p></td>
<td><p>string</p></td>
<td><p>The path to the vault token file. The token file is used by MongoDB to access HashiCorp Vault. The vault token file consists of the raw vault token and does not include any additional strings or parameters.</p>
<p>Example of a vault token file:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>s.uTrHtzsZnEE7KyHeA797CkWA
</pre></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p>vaultSecret</p></td>
<td><p>security.vault.secret</p></td>
<td><p>string</p></td>
<td><p>The path to the vault secret. Note that vault secrets path format must be:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;vault_secret_mount&gt;/data/&lt;custom_path&gt;
</pre></div>
</div>
<p>where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;vault_secret_mount&gt;</span></code> is your Vault KV Secrets Engine;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">data</span></code> is the mandatory path prefix required by Version 2 API;</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">&lt;custom_path&gt;</span></code> is your secrets path</p></li>
</ul>
<p>Example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>secret_v2/data/psmdb-test/rs1-27017
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is recommended to use different secret paths for every database node.</p>
</div>
</td>
</tr>
<tr class="row-even"><td><p>vaultRotateMasterKey</p></td>
<td><p>security.vault.rotateMasterKey</p></td>
<td><p>switch</p></td>
<td><p>Enables master key rotation</p></td>
</tr>
<tr class="row-odd"><td><p>vaultServerCAFile</p></td>
<td><p>security.vault.serverCAFile</p></td>
<td><p>string</p></td>
<td><p>The path to the TLS certificate file</p></td>
</tr>
<tr class="row-even"><td><p>vaultDisableTLSForTesting</p></td>
<td><p>security.vault.disableTLSForTesting</p></td>
<td><p>switch</p></td>
<td><p>Disables secure connection to HashiCorp Vault using SSL/TLS client certificates</p></td>
</tr>
</tbody>
</table>
</div>
<div class="admonition-config-file-example admonition">
<p class="admonition-title">Config file example</p>
<blockquote>
<div><div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">security</span><span class="p">:</span>
<span class="w">  </span><span class="nt">enableEncryption</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">vault</span><span class="p">:</span>
<span class="w">    </span><span class="nt">serverName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
<span class="w">    </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8200</span>
<span class="w">    </span><span class="nt">tokenFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/home/user/path/token</span>
<span class="w">    </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret/data/hello</span>
</pre></div>
</div>
</div></blockquote>
<p>During the first run of the <em>Percona Server for MongoDB</em>, the process generates a secure key and writes the key to the vault.</p>
<p>During the subsequent start, the server tries to read the master key from the vault. If the configured secret does not exist, vault responds with HTTP 404 error.</p>
</div>

<h3 id="key-rotation"><a class="toc-backref" href="#id2">Key Rotation</a><a class="headerlink" href="#key-rotation" title="Permalink to this headline">¶</a></h3>
<p>Key rotation is replacing the old master key with a new one. This process helps to comply with regulatory requirements.</p>
<p>To rotate the keys for a single <code class="docutils literal notranslate"><span class="pre">mongod</span></code> instance, do the following:</p>
<ol class="arabic simple">
<li><p>Stop the <code class="docutils literal notranslate"><span class="pre">mongod</span></code> process</p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">--vaultRotateMasterKey</span></code> option via the command line or <code class="docutils literal notranslate"><span class="pre">security.vault.rotateMasterKey</span></code> to the config file.</p></li>
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">mongod</span></code> process with the selected option, the process will perform the key rotation and exit.</p></li>
<li><p>Remove the selected option from the startup command or the config file.</p></li>
<li><p>Start <code class="docutils literal notranslate"><span class="pre">mongod</span></code> again.</p></li>
</ol>
<p>Rotating the master key process also re-encrypts the keystore using the new master key. The new master key is stored in the vault. The entire dataset is not re-encrypted.</p>
<p>For a replica set, the steps are the following:</p>
<ol class="arabic simple">
<li><p>Rotate the master key for the secondary nodes one by one.</p></li>
<li><p>Step down the primary and wait for another primary to be elected.</p></li>
<li><p>Rotate the master key for the previous primary node.</p></li>
</ol>



<h2 id="local-key-management-using-a-keyfile"><a class="toc-backref" href="#id3">Local key management using a keyfile</a><a class="headerlink" href="#local-key-management-using-a-keyfile" title="Permalink to this headline">¶</a></h2>
<p>The key file must contain a 32 character string encoded in base64. You can generate a random
key and save it to a file by using the <strong class="program">openssl</strong> command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>openssl<span class="w"> </span>rand<span class="w"> </span>-base64<span class="w"> </span><span class="m">32</span><span class="w"> </span>&gt;<span class="w"> </span>mongodb-keyfile
</pre></div>
</div>
<p>Then, as the owner of the <code class="docutils literal notranslate"><span class="pre">mongod</span></code> process, update the file permissions: only
the owner should be able to read and modify this file. The effective permissions specified with the <code class="docutils literal notranslate"><span class="pre">chmod</span></code> command can be:</p>
<ul class="simple">
<li><p><strong>600</strong> - only the owner may read and modify the file</p></li>
<li><p><strong>400</strong> - only the owner may read the file.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>mongodb-keyfile
</pre></div>
</div>
<p>Enable the data encryption at rest in <em>Percona Server for MongoDB</em> by setting these options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--enableEncryption</span></code> to enable data at rest encryption</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--encryptionKeyFile</span></code> to specify the path to a file that contains the encryption key</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>mongod<span class="w"> </span>...<span class="w"> </span>--enableEncryption<span class="w"> </span>--encryptionKeyFile<span class="w"> </span>&lt;fileName&gt;
</pre></div>
</div>
<p>By default, <em>Percona Server for MongoDB</em> uses the <code class="docutils literal notranslate"><span class="pre">AES256-CBC</span></code> cipher mode. If you want to use the <code class="docutils literal notranslate"><span class="pre">AES256-GCM</span></code> cipher mode, then use the <code class="docutils literal notranslate"><span class="pre">encryptionCipherMode</span></code> parameter to change it.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">mongod</span></code> is started with the <code class="docutils literal notranslate"><span class="pre">--relaxPermChecks</span></code> option and the key file
is owned by <code class="docutils literal notranslate"><span class="pre">root</span></code> then <code class="docutils literal notranslate"><span class="pre">mongod</span></code> can read the file based on the
group bit set accordingly. The effective key file permissions in this
case are:</p>
<ul class="simple">
<li><p><strong>440</strong> - both the owner and the group can only read the file, or</p></li>
<li><p><strong>640</strong> - only the owner can read and the change the file, the group can only read the file.</p></li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt>MongoDB Documentation: Configure Encryption</dt><dd><p><a class="reference external" href="https://docs.mongodb.com/manual/tutorial/configure-encryption/#local-key-management">https://docs.mongodb.com/manual/tutorial/configure-encryption/#local-key-management</a></p>
</dd>
<dt><em>Percona</em> Blog: WiredTiger Encryption at Rest with Percona Server for MongoDB</dt><dd><p><a class="reference external" href="https://www.percona.com/blog/2018/11/01/wiredtiger-encryption-at-rest-percona-server-for-mongodb/">https://www.percona.com/blog/2018/11/01/wiredtiger-encryption-at-rest-percona-server-for-mongodb/</a></p>
</dd>
</dl>
</div>
<p>All these options can be specified in the configuration file:</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">security</span><span class="p">:</span>
<span class="w">   </span><span class="nt">enableEncryption</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;boolean&gt;</span>
<span class="w">   </span><span class="nt">encryptionCipherMode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;string&gt;</span>
<span class="w">   </span><span class="nt">encryptionKeyFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;string&gt;</span>
<span class="w">   </span><span class="nt">relaxPermChecks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">&lt;boolean&gt;</span>
</pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<dl class="simple">
<dt>MongoDB Documentation: How to set options in a configuration file</dt><dd><p><a class="reference external" href="https://docs.mongodb.com/manual/reference/configuration-options/index.html#configuration-file">https://docs.mongodb.com/manual/reference/configuration-options/index.html#configuration-file</a></p>
</dd>
</dl>
</div>


<h2 id="encrypting-rollback-files"><a class="toc-backref" href="#id4">Encrypting Rollback Files</a><a class="headerlink" href="#encrypting-rollback-files" title="Permalink to this headline">¶</a></h2>
<p>Starting from version 3.6, <em>Percona Server for MongoDB</em> also encrypts rollback files when data at
rest encryption is enabled. To inspect the contents of these files, use
<strong class="program">perconadecrypt</strong>. This is a tool that you run from the command line as follows:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>perconadecrypt<span class="w"> </span>--encryptionKeyFile<span class="w"> </span>FILE<span class="w">  </span>--inputPath<span class="w"> </span>FILE<span class="w"> </span>--outputPath<span class="w"> </span>FILE<span class="w"> </span><span class="o">[</span>--encryptionCipherMode<span class="w"> </span>MODE<span class="o">]</span>
</pre></div>
</div>
<p>When decrypting, the cipher mode must match the cipher mode which was used for
the encryption. By default, the <code class="docutils literal notranslate"><span class="pre">--encryptionCipherMode</span></code> option uses the
AES256-CBC mode.</p>
<div class="admonition-parameters-of-perconadecrypt admonition">
<p class="admonition-title">Parameters of <strong class="program">perconadecrypt</strong></p>
<table>
<colgroup>
<col style="width: 23%"/>
<col style="width: 77%"/>
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Option</p></th>
<th class="head"><p>Purpose</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>–encryptionKeyFile</p></td>
<td><p>The path to the encryption key file</p></td>
</tr>
<tr class="row-odd"><td><p>–encryptionCipherMode</p></td>
<td><p>The cipher mode for decryption. The supported values are AES256-CBC or AES256-GCM</p></td>
</tr>
<tr class="row-even"><td><p>–inputPath</p></td>
<td><p>The path to the encrypted rollback file</p></td>
</tr>
<tr class="row-odd"><td><p>–outputPath</p></td>
<td><p>The path to save the decrypted rollback file</p></td>
</tr>
</tbody>
</table>
</div>


<span id="psmdb-encryption-mode-switch"></span><h2 id="migrating-from-key-file-encryption-to-vault-encryption"><a class="toc-backref" href="#id5">Migrating from Key File Encryption to HashiCorp Vault Encryption</a><a class="headerlink" href="#migrating-from-key-file-encryption-to-vault-encryption" title="Permalink to this headline">¶</a></h2>
<p>The steps below describe how to migrate from the key file encryption to using  HashiCorp Vault.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a simple guideline and it should be used for testing purposes only. We recommend to use Percona Consulting Services to assist you with migration in production environment.</p>
</div>
<p class="rubric">Assumptions</p>
<p>We assume that you have installed and configured the vault server and enabled the KV Secrets Engine as the secrets storage for it.</p>
<ol class="arabic">
<li><p>Stop <code class="docutils literal notranslate"><span class="pre">mongod</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>stop<span class="w"> </span>mongod
</pre></div>
</div>
</li>
<li><p>Insert the key from keyfile into the HashiCorp Vault server to the desired secret
path.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Retrieve the key value from the keyfile</span>
$<span class="w"> </span>sudo<span class="w"> </span>cat<span class="w"> </span>/data/key/mongodb.key
d0JTFcePmvROyLXwCbAH8fmiP/ZRm0nYbeJDMGaI7Zw<span class="o">=</span>
<span class="c1"># Insert the key into vault</span>
$<span class="w"> </span>vault<span class="w"> </span>kv<span class="w"> </span>put<span class="w"> </span>secret/dc/psmongodb1<span class="w"> </span><span class="nv">value</span><span class="o">=</span>d0JTFcePmvROyLXwCbAH8fmiP/ZRm0nYbeJDMGaI7Zw<span class="o">=</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Vault KV Secrets Engine uses different read and write secrets paths. To insert data to vault, specify the secret path without the <code class="docutils literal notranslate"><span class="pre">data/</span></code> prefix.</p>
</div>
</li>
<li><p>Edit the configuration file to provision the HashiCorp Vault configuration options instead of the key file encryption options.</p>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="nt">security</span><span class="p">:</span>
<span class="w">   </span><span class="nt">enableEncryption</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">   </span><span class="nt">vault</span><span class="p">:</span>
<span class="w">      </span><span class="nt">serverName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.2.15</span>
<span class="w">      </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8200</span>
<span class="w">      </span><span class="nt">secret</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">secret/data/dc/psmongodb1</span>
<span class="w">      </span><span class="nt">tokenFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/mongodb/token</span>
<span class="w">      </span><span class="nt">serverCAFile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/mongodb/vault.crt</span>
</pre></div>
</div>
</li>
<li><p>Start the <code class="docutils literal notranslate"><span class="pre">mongod</span></code> service</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$<span class="w"> </span>sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>mongod
</pre></div>
</div>
</li>
</ol>




          </article>
        </div>
      </div>
    </main>
  </div>
<div class="md-relbar2__inner md-grid">
<div class="md-content">
  <article class="md-content__inner md-typeset" role="main">    
    <h4>Contact Us </h4>
       <p>For free technical help, visit the Percona <a class="reference external" href="https://forums.percona.com/c/mongodb/percona-server-for-mongodb/17?utm_campaign=Doc%20pages" target="_blank">Community Forum</a>.<br>
        <p>To report bugs or submit feature requests, open a <a class="reference external" href="https://jira.percona.com/projects/PSMDB/issues/" target="_blank">JIRA</a> ticket.<br>
         <p>For paid <a class="reference external" href="https://www.percona.com/services/support"> support </a> and <a class="reference external" href="https://www.percona.com/services/managed-services"> managed </a> or <a class="reference external" href="https://www.percona.com/services/consulting">consulting services </a>, contact <a class="reference external" href="https://www.percona.com/about-percona/contact" target="_blank">Percona Sales</a>.</p>
 </article>
</div>
</div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="enable-auth.html" title="Enabling Authentication"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> Enabling Authentication </span>
              </div>
            </a>
          
          
            <a href="ngram-full-text-search.html" title="Additional text search algorithm - ngram"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> Additional text search algorithm - <em>ngram</em> </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169;
                <a href="copyright.html">Copyright</a> Percona LLC and/or its affiliates 2015-2022.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 4.2.0.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>